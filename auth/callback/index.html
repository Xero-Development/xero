<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Auth Callback | The X Project</title>
  <link rel="stylesheet" href="../../assets/styles.css"/>
  <script src="../../assets/config.js"></script>
  <script src="../../assets/app.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Signing you in…</h1>
      <p class="muted">Parsing token from the URL fragment and storing it in session storage.</p>
      <p class="muted" id="status">Working…</p>
      <div class="row" style="margin-top:12px;">
        <a class="btn ghost" href="../../">Back to Home</a>
      </div>
    </div>
  </div>

  <script>
    function parseHash(){
      const h = location.hash.startsWith("#") ? location.hash.slice(1) : location.hash;
      const p = new URLSearchParams(h);
      const access = p.get("access_token");
      const state = p.get("state");
      const err = p.get("error");
      return { access, state, err };
    }

    (async () => {
      const s = document.getElementById("status");
      const { access, state, err } = parseHash();

      if(err){
        s.textContent = "Discord returned error: " + err;
        return;
      }
      if(!access){
        s.textContent = "No access_token found. Did you cancel login?";
        return;
      }

      const expected = sessionStorage.getItem("xp_oauth_state");
      if(expected && state && expected !== state){
        s.textContent = "State mismatch. Not storing token.";
        return;
      }

      XP.setToken(access);
      sessionStorage.removeItem("xp_oauth_state");
      s.textContent = "Token stored. Loading user…";

      const me = await XP.fetchMe().catch(() => null);
      if(me){
        s.textContent = "Logged in as " + me.username + "#" + (me.discriminator || "0000") + ". Redirecting…";
      } else {
        s.textContent = "Stored token, but failed to fetch /users/@me. Redirecting anyway…";
      }

      setTimeout(() => location.href = "../../", 500);
    })();
  </script>
</body>
</html>
